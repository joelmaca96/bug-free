rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Función auxiliar para verificar autenticación
    function isAuthenticated() {
      return request.auth != null;
    }

    // Función para obtener los datos del usuario
    function getUserData() {
      return get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data;
    }

    // Función para verificar si el usuario es superuser
    function isSuperuser() {
      return isAuthenticated() && getUserData().rol == 'superuser';
    }

    // Función para verificar si el usuario es admin
    function isAdmin() {
      return isAuthenticated() && getUserData().rol == 'admin';
    }

    // Función para verificar si el usuario es gestor
    function isGestor() {
      return isAuthenticated() && getUserData().rol == 'gestor';
    }

    // Función para verificar si el usuario pertenece a la misma empresa
    function isSameEmpresa(empresaId) {
      return isAuthenticated() && getUserData().empresaId == empresaId;
    }

    // Función para verificar si el usuario pertenece a la misma farmacia
    function isSameFarmacia(farmaciaId) {
      return isAuthenticated() && getUserData().farmaciaId == farmaciaId;
    }

    // Función para verificar si el usuario es admin o gestor de una farmacia
    function isAdminOrGestorOfFarmacia(farmaciaId) {
      let userData = getUserData();
      return isAuthenticated() && (
        (userData.rol == 'admin' && farmaciaInUserEmpresa(farmaciaId)) ||
        (userData.farmaciaId == farmaciaId && (userData.rol == 'gestor' || userData.rol == 'admin'))
      );
    }

    // Función para verificar si una farmacia pertenece a la empresa del usuario
    function farmaciaInUserEmpresa(farmaciaId) {
      let farmacia = get(/databases/$(database)/documents/farmacias/$(farmaciaId)).data;
      return isAuthenticated() && getUserData().empresaId == farmacia.empresaId;
    }

    // Reglas para usuarios
    match /usuarios/{userId} {
      // SuperUser puede ver todos los usuarios
      // Admin puede ver usuarios de su empresa (excepto superusers)
      // Gestor puede ver usuarios de su farmacia (excepto superusers)
      // Usuarios pueden ver su propia información
      allow read: if isAuthenticated() && (
        request.auth.uid == userId ||
        isSuperuser() ||
        (isAdmin() && isSameEmpresa(resource.data.empresaId) && resource.data.rol != 'superuser') ||
        (isGestor() && isSameFarmacia(resource.data.farmaciaId) && resource.data.rol != 'superuser')
      );

      // SuperUser puede crear cualquier usuario
      // Admin puede crear gestores y empleados de su empresa
      // Gestor puede crear empleados de su farmacia
      allow create: if isAuthenticated() && (
        (request.auth.uid == userId && request.resource.data.rol == 'empleado') ||
        isSuperuser() ||
        (isAdmin() && isSameEmpresa(request.resource.data.empresaId) &&
         request.resource.data.rol in ['gestor', 'empleado']) ||
        (isGestor() && isSameFarmacia(request.resource.data.farmaciaId) &&
         request.resource.data.rol == 'empleado')
      );

      // Los usuarios pueden actualizar su propia información (excepto rol y asignaciones)
      // SuperUser puede actualizar cualquier usuario
      // Admin puede actualizar usuarios de su empresa (excepto superusers)
      // Gestor puede actualizar empleados de su farmacia
      allow update: if isAuthenticated() && (
        (request.auth.uid == userId &&
         request.resource.data.rol == resource.data.rol &&
         request.resource.data.farmaciaId == resource.data.farmaciaId &&
         request.resource.data.empresaId == resource.data.empresaId) ||
        isSuperuser() ||
        (isAdmin() && isSameEmpresa(resource.data.empresaId) && resource.data.rol != 'superuser') ||
        (isGestor() && isSameFarmacia(resource.data.farmaciaId) && resource.data.rol == 'empleado')
      );

      // SuperUser puede eliminar cualquier usuario
      // Admin puede eliminar usuarios de su empresa (excepto superusers)
      allow delete: if isSuperuser() || (isAdmin() && isSameEmpresa(resource.data.empresaId) && resource.data.rol != 'superuser');
    }

    // Reglas para empresas
    match /empresas/{empresaId} {
      // SuperUser puede ver todas las empresas
      // Admin puede ver su propia empresa
      allow read: if isAuthenticated() && (
        isSuperuser() ||
        (isAdmin() && isSameEmpresa(empresaId))
      );

      // Solo SuperUser puede crear empresas
      allow create: if isSuperuser();

      // SuperUser puede actualizar cualquier empresa
      // Admin puede actualizar solo su propia empresa
      allow update: if isSuperuser() || (isAdmin() && isSameEmpresa(empresaId));

      // Solo SuperUser puede eliminar empresas
      allow delete: if isSuperuser();
    }

    // Reglas para farmacias
    match /farmacias/{farmaciaId} {
      // SuperUser puede ver todas las farmacias
      // Admin puede ver farmacias de su empresa
      // Gestor puede ver su farmacia asignada
      allow read: if isAuthenticated() && (
        isSuperuser() ||
        (isAdmin() && isSameEmpresa(resource.data.empresaId)) ||
        (isGestor() && isSameFarmacia(farmaciaId))
      );

      // SuperUser puede crear cualquier farmacia
      // Admin puede crear farmacias SOLO para su empresa
      allow create: if isSuperuser() ||
        (isAdmin() && isSameEmpresa(request.resource.data.empresaId));

      // SuperUser puede actualizar cualquier farmacia
      // Admin puede actualizar farmacias de su empresa
      // Gestor puede actualizar su farmacia asignada
      allow update: if isSuperuser() ||
        (isAdmin() && isSameEmpresa(resource.data.empresaId) && isSameEmpresa(request.resource.data.empresaId)) ||
        (isGestor() && isSameFarmacia(farmaciaId));

      // SuperUser y Admin pueden eliminar farmacias de su empresa
      allow delete: if isSuperuser() || (isAdmin() && isSameEmpresa(resource.data.empresaId));
    }

    // Reglas para calendarios y turnos
    match /calendarios/{farmaciaId}/turnos/{turnoId} {
      // SuperUser puede ver todos los turnos
      // Admin puede ver turnos de farmacias de su empresa
      // Gestor puede ver turnos de su farmacia
      // Empleados pueden ver turnos de su farmacia
      allow read: if isAuthenticated() && (
        isSuperuser() ||
        (isAdmin() && farmaciaInUserEmpresa(farmaciaId)) ||
        isSameFarmacia(farmaciaId)
      );

      // SuperUser puede crear/modificar cualquier turno
      // Admin puede crear/modificar turnos de farmacias de su empresa
      // Gestor puede crear/modificar turnos de su farmacia
      allow create, update: if isSuperuser() ||
        (isAdmin() && farmaciaInUserEmpresa(farmaciaId)) ||
        (isGestor() && isSameFarmacia(farmaciaId));

      // SuperUser puede eliminar cualquier turno
      // Admin puede eliminar turnos de farmacias de su empresa
      // Gestor puede eliminar turnos de su farmacia
      allow delete: if isSuperuser() ||
        (isAdmin() && farmaciaInUserEmpresa(farmaciaId)) ||
        (isGestor() && isSameFarmacia(farmaciaId));
    }

    // Reglas para configuración del algoritmo
    match /configuracionesAlgoritmo/{configId} {
      // SuperUser puede leer todas las configuraciones
      // Admin puede leer configuraciones de farmacias de su empresa
      // Gestor puede leer configuración de su farmacia
      allow read: if isAuthenticated() && (
        isSuperuser() ||
        (isAdmin() && isSameEmpresa(resource.data.empresaId)) ||
        isSameFarmacia(resource.data.farmaciaId)
      );

      // SuperUser puede crear/modificar cualquier configuración
      // Admin puede crear/modificar configuraciones de farmacias de su empresa
      // Gestor puede crear/modificar configuración de su farmacia
      allow create: if isSuperuser() ||
        (isAdmin() && isSameEmpresa(request.resource.data.empresaId)) ||
        (isGestor() && isSameFarmacia(request.resource.data.farmaciaId));

      allow update: if isSuperuser() ||
        (isAdmin() && isSameEmpresa(resource.data.empresaId) && isSameEmpresa(request.resource.data.empresaId)) ||
        (isGestor() && isSameFarmacia(resource.data.farmaciaId));

      // SuperUser puede eliminar cualquier configuración
      // Admin puede eliminar configuraciones de farmacias de su empresa
      allow delete: if isSuperuser() || (isAdmin() && isSameEmpresa(resource.data.empresaId));
    }

    // Denegar acceso a cualquier otra colección no especificada
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
